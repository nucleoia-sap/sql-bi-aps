<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanseníase - BI Prefeitura</title>
    <link rel="shortcut icon" href="../assets/logos/logo-prefeitura-3.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

    <link rel="stylesheet" href="../styles/global.css">
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Mobile Header -->
    <div class="fixed w-full bg-slate-900 text-white z-50 flex items-center justify-between p-4 md:hidden">
        <div class="font-bold text-lg flex items-center gap-2">
            <i class="ph ph-bank text-sky-400"></i> BI-APS
        </div>
        <button onclick="toggleSidebar()" class="text-white focus:outline-none">
            <i class="ph ph-list text-2xl"></i>
        </button>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="bg-slate-900 text-slate-300 w-64 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex flex-col h-full shadow-xl">

        <!-- Header Sidebar -->
        <div
            class="p-6 pt-24 md:pt-8 border-b border-slate-800 flex flex-col items-center justify-center text-center gap-2">
            <div class="w-40 h-auto flex items-center justify-center mb-2">
                <img src="../assets/logos/logo-prefeitura-2.png" alt="Logo Prefeitura"
                    class="w-full h-auto object-contain">
            </div>
            <div class="flex flex-col gap-1 w-full mt-5">
                <h1 class="font-bold text-white text-xl tracking-wide">BI-APS</h1>
                <p
                    class="text-[10px] text-slate-500 uppercase tracking-[0.2em] font-medium border-t border-slate-800 pt-2 mt-1">
                    Documentação</p>
            </div>
        </div>

        <!-- Busca -->
        <div class="p-4">
            <div class="relative">
                <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-slate-500"></i>
                <input id="sidebar-search" type="text" placeholder="Buscar query..."
                    class="w-full bg-slate-800 text-sm text-slate-200 rounded-md pl-9 pr-4 py-2 focus:outline-none focus:ring-1 focus:ring-sky-500 border border-slate-700 placeholder-slate-500 transition-all focus:border-sky-500/50">
            </div>
        </div>

        <!-- Menu de Navegação -->
        <nav class="flex-1 overflow-y-auto py-2 space-y-6 px-3 custom-scrollbar">

            <!-- Link Visão Geral -->
            <div>
                <a href="../index.html"
                    class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium">
                    <i class="ph ph-house"></i> Visão Geral
                </a>
            </div>

            <!-- Grupo: BI APS -->
            <div>
                <h3 class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">BI APS (Atenção
                    Primária)</h3>
                <ul class="space-y-1">

                    <!-- 1. Query - QUEM SOMOS (Ativo)-->
                    <li>
                        <a href="./bi_aps_quem_somos.html"
                            class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-slate-400 hover:text-white hover:bg-slate-800/50 transition-colors">
                            <i class="ph ph-identification-card"></i> Query - QUEM SOMOS
                        </a>
                    </li>

                    <!-- 2. Dropdown Pai: A QUEM SERVIMOS -->
                    <li>
                        <button onclick="toggleSubmenu('submenu-servimos', 'chevron-servimos')"
                            class="active sidebar-link w-full flex items-center justify-between px-3 py-2 rounded-md text-sm text-slate-400 hover:text-white hover:bg-slate-800/50 group text-left focus:outline-none transition-colors">
                            <div class="flex items-center gap-3">
                                <i class="ph ph-users-three"></i>
                                A QUEM SERVIMOS
                            </div>
                            <i id="chevron-servimos"
                                class="ph ph-caret-down text-slate-500 transition-transform duration-200 rotate-180"></i>
                        </button>

                        <!-- Container do Submenu Servimos -->
                        <div id="submenu-servimos"
                            class="pl-7 pr-2 py-1 space-y-1 overflow-hidden transition-all duration-300">

                            <!-- Link Simples dentro do Servimos -->
                            <a href="./bi_aps_a_quem_servimos.html"
                                class="submenu-link block py-2 text-sm text-slate-400 hover:text-sky-400 transition-colors">
                                Query - A QUEM SERVIMOS
                            </a>

                            <!-- Dropdown Aninhado (Perfil clínico-epidemiológico) -->
                            <div class="mt-1">
                                <button onclick="toggleSubmenu('submenu-perfil', 'chevron-perfil')"
                                    class="sidebar-link w-full flex items-center justify-between px-3 py-2 rounded-md text-sm text-slate-400 hover:text-white hover:bg-slate-800/50 group text-left focus:outline-none transition-colors overflow-hidden">
                                    <div class="flex items-center gap-3 overflow-hidden w-full">
                                        <i class="ph ph-chart-bar flex-shrink-0"></i>
                                        <div class="marquee-container">
                                            <span class="marquee-text">Perfil clínico-epidemiológico</span>
                                        </div>
                                    </div>
                                    <i id="chevron-perfil"
                                        class="ph ph-caret-down text-slate-500 transition-transform duration-200"></i>
                                </button>

                                <!-- Submenu do Perfil (Hanseníase, TB, etc) -->
                                <div id="submenu-perfil"
                                    class="pl-8 pr-2 py-1 space-y-1 overflow-hidden transition-all duration-300">
                                    <a href="./bi_aps_hanseniase.html"
                                        class="submenu-link block py-2 text-sm text-slate-400 hover:text-sky-400 transition-colors">
                                        Query - Hanseníase
                                    </a>
                                    <a href="./emConstrucao.html"
                                        class="submenu-link block py-2 text-sm text-slate-400 hover:text-sky-400 transition-colors">
                                        Query - Turbeculose
                                    </a>
                                    <a href="./emConstrucao.html"
                                        class="submenu-link block py-2 text-sm text-slate-400 hover:text-sky-400 transition-colors">
                                        Query - Sífilis
                                    </a>
                                    <a href="./emConstrucao.html"
                                        class="submenu-link block py-2 text-sm text-slate-400 hover:text-sky-400 transition-colors">
                                        Query - Hepatites
                                    </a>
                                </div>
                            </div>
                        </div>
                    </li>

                </ul>
            </div>
        </nav>

        <!-- Footer Sidebar -->
        <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center" id="versao-sistema">
        </div>
    </aside>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full bg-slate-50">
        <div class="flex-1 overflow-y-auto p-6 md:p-10 pt-20 md:pt-10">
            <div class="max-w-6xl mx-auto">

                <!-- Cabeçalho da Query -->
                <div
                    class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 pb-6 border-b border-slate-200">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span
                                class="bg-amber-100 text-amber-700 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide">Agravo
                                Específico</span>
                            <span class="text-slate-400 text-sm">/</span>
                            <span class="text-slate-500 text-sm">Linha de Cuidado</span>
                        </div>
                        <h1 class="text-3xl font-bold text-slate-900">QUERY - HANSENÍASE</h1>
                        <p class="text-slate-600 mt-1">Identificação de pacientes em tratamento ativo via critérios
                            clínicos,
                            medicamentosos e administrativos.</p>
                    </div>
                    <div class="flex gap-3">
                        <a href="#"
                            class="flex items-center gap-2 bg-sky-600 text-white hover:bg-sky-700 px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm">
                            <i class="ph ph-arrow-square-out"></i> Abrir no BigQuery
                        </a>
                    </div>
                </div>

                <!-- Resumo / Metadados -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Tabela Final</p>
                        <p class="text-slate-800 font-medium text-xs break-all font-mono bg-slate-50 p-1 rounded">
                            rj-sms-sandbox.sub_pav_us._hanseniase_em_tratamento
                        </p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Fontes Principais</p>
                        <div class="text-slate-800 font-medium text-sm flex flex-col gap-1">
                            <span class="flex items-center gap-1"><i class="ph ph-pill"></i> Prescrições
                                (Medicamentos)</span>
                            <span class="flex items-center gap-1"><i class="ph ph-file-text"></i> Vitacare (Lista
                                Oficial)</span>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Janela Temporal</p>
                        <p class="text-slate-800 font-medium flex items-center gap-2">
                            <i class="ph ph-calendar text-amber-500"></i> Últimos 18 Meses
                        </p>
                    </div>
                </div>

                <!-- Sistema de Abas -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-10">
                    <div class="border-b border-slate-200 flex overflow-x-auto bg-slate-50">
                        <button onclick="openTab('regras')" id="btn-regras"
                            class="tab-btn active px-6 py-4 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Regras
                            de Negócio</button>
                        <button onclick="openTab('sql')" id="btn-sql"
                            class="tab-btn px-6 py-4 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Script
                            SQL</button>
                        <button onclick="openTab('dicionario')" id="btn-dicionario"
                            class="tab-btn px-6 py-4 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Dicionário
                            de Dados</button>
                    </div>

                    <!-- Conteúdo: Regras de Negócio -->
                    <div id="regras" class="tab-content active p-8">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Critérios de Inclusão (Multicritério)</h3>
                        <p class="text-slate-600 text-sm mb-6">
                            Para maximizar a sensibilidade da detecção, um paciente é considerado "Em Tratamento" se
                            atender a
                            <strong>pelo menos um</strong> dos critérios abaixo na janela dos últimos 18 meses.
                        </p>
                        <ul class="space-y-6">
                            <li class="flex gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    <span
                                        class="flex items-center justify-center w-6 h-6 rounded-full bg-purple-100 text-purple-600 font-bold text-xs">1</span>
                                </div>
                                <div>
                                    <strong class="text-slate-900 block">Critério Farmacológico (Prescrições)</strong>
                                    <p class="text-slate-600 text-sm mt-1">
                                        Identificação de medicamentos rastreadores específicos (poliquimioterapia).
                                        <br><span
                                            class="text-xs bg-slate-100 px-1 py-0.5 rounded text-slate-500 font-mono mt-1 inline-block">Rifampicina
                                            + Clofazimina + Dapsona</span> ou combinações com Ofloxacino/Minociclina.
                                    </p>
                                </div>
                            </li>
                            <li class="flex gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    <span
                                        class="flex items-center justify-center w-6 h-6 rounded-full bg-purple-100 text-purple-600 font-bold text-xs">2</span>
                                </div>
                                <div>
                                    <strong class="text-slate-900 block">Critério Clínico (CID Ativo)</strong>
                                    <p class="text-slate-600 text-sm mt-1">
                                        Registro de Episódio Assistencial com diagnóstico CID iniciando em
                                        <strong>A30</strong> (Hanseníase)
                                        e situação marcada como 'ATIVO' em qualquer momento da janela temporal.
                                    </p>
                                </div>
                            </li>
                            <li class="flex gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    <span
                                        class="flex items-center justify-center w-6 h-6 rounded-full bg-purple-100 text-purple-600 font-bold text-xs">3</span>
                                </div>
                                <div>
                                    <strong class="text-slate-900 block">Critério Administrativo (Lista
                                        Oficial)</strong>
                                    <p class="text-slate-600 text-sm mt-1">
                                        Presença na lista oficial de notificação (SINAN/Vitacare). Como essa lista as
                                        vezes não possui CPF,
                                        é feito um cruzamento (JOIN) com a tabela <code>acto</code> para recuperar o CPF
                                        do paciente via
                                        chave composta (CNES + Prontuário).
                                    </p>
                                </div>
                            </li>
                            <li class="flex gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="ph ph-funnel text-slate-400 text-xl"></i>
                                </div>
                                <div>
                                    <strong class="text-slate-900 block">Filtro de Escopo (APS)</strong>
                                    <p class="text-slate-600 text-sm mt-1">
                                        A lista final é filtrada para conter apenas unidades classificadas como
                                        <strong>Atenção Primária à
                                            Saúde (APS)</strong> na tabela mestre de estabelecimentos.
                                    </p>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- Conteúdo: SQL -->
                    <div id="sql" class="tab-content p-0">
                        <div class="relative">
                            <button onclick="copySql()"
                                class="absolute top-4 right-4 bg-slate-700 hover:bg-slate-600 text-white text-xs px-3 py-1.5 rounded flex items-center gap-2 transition-colors z-10">
                                <i class="ph ph-copy"></i> Copiar
                            </button>
                            <pre class="m-0"><code class="language-sql shadow-none rounded-none">
-- ======================================================================
-- Parâmetro dinâmico: 18 meses antes da execução
-- ======================================================================
DECLARE data_corte DATETIME DEFAULT DATETIME_SUB(CURRENT_DATETIME(), INTERVAL 18 MONTH);

-- ======================================================================
-- 1) LISTA DE HANSENÍASE COM CPF (chave: id_cnes|'|'|id_prontuario_local)
--    Fonte sem CPF: rj-sms.brutos_prontuario_vitacare_historico.hanseniase
--    CPF via ACTO:  rj-sms.brutos_prontuario_vitacare_historico.acto
-- ======================================================================
CREATE OR REPLACE TABLE `rj-sms-sandbox.sub_pav_us._hanseniase_lista_com_cpf` AS
WITH
hs_base AS (
  SELECT
    TRIM(id_cnes) AS id_cnes_norm,
    TRIM(id_prontuario_local) AS id_pl_norm,
    CONCAT(TRIM(id_cnes), '|', TRIM(id_prontuario_local)) AS chave_hs,
    h.*
  FROM `rj-sms.brutos_prontuario_vitacare_historico.hanseniase` h
),
acto_base AS (
  SELECT
    TRIM(id_cnes) AS id_cnes_norm,
    TRIM(id_prontuario_local) AS id_pl_norm,
    CONCAT(TRIM(id_cnes), '|', TRIM(id_prontuario_local)) AS chave_hs,
    REGEXP_REPLACE(TRIM(patient_cpf), r'\D', '') AS paciente_cpf_digits
  FROM `rj-sms.brutos_prontuario_vitacare_historico.acto`
  WHERE patient_cpf IS NOT NULL
    AND LENGTH(TRIM(patient_cpf)) > 0
),
acto_chave_cpf AS (
  SELECT
    chave_hs,
    ANY_VALUE(paciente_cpf_digits) AS paciente_cpf_digits
  FROM acto_base
  WHERE chave_hs IS NOT NULL
    AND paciente_cpf_digits IS NOT NULL
    AND LENGTH(paciente_cpf_digits) = 11
  GROUP BY chave_hs
)
SELECT
  hs.*,
  ac.paciente_cpf_digits AS paciente_cpf
FROM hs_base hs
LEFT JOIN acto_chave_cpf ac
  ON hs.chave_hs = ac.chave_hs
;

-- ======================================================================
-- 2) TABELA FINAL: _hanseniase_em_tratamento
--    Critérios:
--    (1) Prescrição relevante
--    (2) CID A30* ativo na janela e ativo no registro mais recente
--    (3) Presença na lista de Hanseníase (com CPF)
-- ======================================================================
CREATE OR REPLACE TABLE `rj-sms-sandbox.sub_pav_us._hanseniase_em_tratamento` AS
WITH
/* 2.1) PRESCRIÇÕES RELEVANTES (EA)
   - Rifampicina + Clofazimina + Dapsona (padrão)
   - OU (qualquer 2 desses) + (Ofloxacino OU Minociclina)
*/
hs_prescricao_raw AS (
  SELECT
    REGEXP_REPLACE(TRIM(ea.paciente_cpf), r'\D', '') AS paciente_cpf,
    ea.entrada_datahora AS data_prescricao,
    LOWER(p.nome) AS nome_medicamento
  FROM `rj-sms.saude_historico_clinico.episodio_assistencial` AS ea,
       UNNEST(ea.prescricoes) AS p
  WHERE
    ea.entrada_datahora >= data_corte
    AND ea.paciente_cpf IS NOT NULL
    AND LENGTH(TRIM(ea.paciente_cpf)) > 0
    AND REGEXP_CONTAINS(
          LOWER(p.nome),
          r'rifampicin|rifampicina|clofazim|clofazimina|dapson|dapsona|ofloxac|ofloxacino|minociclin|minociclina'
        )
),
tokens AS (
  SELECT
    paciente_cpf,
    data_prescricao,
    LOWER(TRIM(tok)) AS tok
  FROM hs_prescricao_raw,
  UNNEST(SPLIT(REGEXP_REPLACE(nome_medicamento, r'\+', ','))) AS tok
),
flags_base AS (
  SELECT
    paciente_cpf,
    data_prescricao,
    COUNTIF(REGEXP_CONTAINS(tok, r'rifampicin|rifampicina')) > 0 AS has_rifa,
    COUNTIF(REGEXP_CONTAINS(tok, r'clofazim|clofazimina'))    > 0 AS has_clofa,
    COUNTIF(REGEXP_CONTAINS(tok, r'dapson|dapsona'))          > 0 AS has_dapso,
    COUNTIF(REGEXP_CONTAINS(tok, r'ofloxac|ofloxacino'))      > 0 AS has_oflox,
    COUNTIF(REGEXP_CONTAINS(tok, r'minociclin|minociclina'))  > 0 AS has_minoc
  FROM tokens
  GROUP BY paciente_cpf, data_prescricao
),
esquema_por_consulta AS (
  SELECT
    paciente_cpf,
    data_prescricao,
    has_rifa, has_clofa, has_dapso, has_oflox, has_minoc,
    (CAST(has_rifa AS INT64) + CAST(has_clofa AS INT64) + CAST(has_dapso AS INT64)) AS cnt_base3,
    CASE
      WHEN (has_rifa AND has_clofa AND has_dapso) THEN 'PADRAO_RCD'
      WHEN ( (CAST(has_rifa AS INT64)+CAST(has_clofa AS INT64)+CAST(has_dapso AS INT64)) >= 2
             AND (has_oflox OR has_minoc) ) THEN 'BASE2_PLUS_ADJ'
      ELSE NULL
    END AS tipo_esquema
  FROM flags_base
),
consultas_validas AS (
  SELECT
    e.paciente_cpf,
    e.data_prescricao,
    e.tipo_esquema,
    ARRAY_TO_STRING(
      ARRAY(
        SELECT med FROM UNNEST([
          IF(e.has_rifa, 'rifampicina', NULL),
          IF(e.has_clofa, 'clofazimina', NULL),
          IF(e.has_dapso, 'dapsona', NULL),
          IF(e.has_oflox,'ofloxacino', NULL),
          IF(e.has_minoc,'minociclina', NULL)
        ]) med
        WHERE med IS NOT NULL
      ), ', '
    ) AS lista_meds_consulta
  FROM esquema_por_consulta e
  WHERE e.tipo_esquema IS NOT NULL
),
presc_cpfs AS (
  SELECT DISTINCT paciente_cpf
  FROM consultas_validas
  WHERE paciente_cpf IS NOT NULL AND LENGTH(paciente_cpf) = 11
),
presc_meds_ult AS (
  SELECT paciente_cpf,
         lista_meds_consulta AS medicamentos_prescritos_mais_recente
  FROM (
    SELECT
      paciente_cpf,
      lista_meds_consulta,
      ROW_NUMBER() OVER (PARTITION BY paciente_cpf ORDER BY data_prescricao DESC) AS rn
    FROM consultas_validas
    WHERE paciente_cpf IS NOT NULL AND LENGTH(paciente_cpf) = 11
  )
  WHERE rn = 1
),

/* 2.2) CID — A30* (Hanseníase)
   Regra: teve ativo em algum momento nos últimos 18 meses (independente do status atual)
*/
cid_eventos AS (
  SELECT
    REGEXP_REPLACE(TRIM(ea.paciente_cpf), r'\D', '') AS paciente_cpf,
    UPPER(TRIM(c.situacao)) AS situacao_norm,
    IFNULL(SAFE_CAST(c.data_diagnostico AS DATETIME), ea.entrada_datahora) AS dt_ref
  FROM `rj-sms.saude_historico_clinico.episodio_assistencial` AS ea,
       UNNEST(ea.condicoes) AS c
  WHERE
    LOWER(c.id) LIKE 'a30%'  -- CID A30 = hanseníase
    AND IFNULL(SAFE_CAST(c.data_diagnostico AS DATETIME), ea.entrada_datahora) >= data_corte
    AND ea.paciente_cpf IS NOT NULL
    AND LENGTH(TRIM(ea.paciente_cpf)) = 11
),
cid_teve_ativo AS (
  SELECT DISTINCT paciente_cpf
  FROM cid_eventos
  WHERE situacao_norm = 'ATIVO'
),
cid_cpfs AS (
  SELECT DISTINCT paciente_cpf FROM cid_teve_ativo
),

/* 2.3) Lista Hanseníase (por CPF) */
lista_info AS (
  SELECT
    REGEXP_REPLACE(TRIM(paciente_cpf), r'\D', '') AS paciente_cpf,
    numero_sinan_hansen AS num_sinan,
    id_cnes AS id_cnes_lista
  FROM (
    SELECT
      paciente_cpf,
      numero_sinan_hansen,
      id_cnes,
      data_inicio_tratamento,
      ROW_NUMBER() OVER (PARTITION BY paciente_cpf ORDER BY data_inicio_tratamento DESC) AS rn
    FROM `rj-sms-sandbox.sub_pav_us._hanseniase_lista_com_cpf`
    WHERE data_inicio_tratamento >= data_corte
      AND paciente_cpf IS NOT NULL AND LENGTH(TRIM(paciente_cpf)) > 0
  )
  WHERE rn = 1
    AND LENGTH(REGEXP_REPLACE(TRIM(paciente_cpf), r'\D', '')) = 11
),
lista_cpfs AS (
  SELECT DISTINCT paciente_cpf FROM lista_info
),

/* 2.4) EA — mais recente na janela (para unidade de referência) */
ea_info AS (
  SELECT
    paciente_cpf,
    motivo_atendimento,
    desfecho_atendimento,
    estabelecimento.id_cnes  AS id_cnes_ea,
    estabelecimento.nome     AS unidade_nome_ea
  FROM (
    SELECT
      REGEXP_REPLACE(TRIM(paciente_cpf), r'\D', '') AS paciente_cpf,
      motivo_atendimento, desfecho_atendimento, estabelecimento, entrada_datahora,
      ROW_NUMBER() OVER (PARTITION BY REGEXP_REPLACE(TRIM(paciente_cpf), r'\D', '') ORDER BY entrada_datahora DESC) AS rn
    FROM `rj-sms.saude_historico_clinico.episodio_assistencial`
    WHERE entrada_datahora >= data_corte
      AND paciente_cpf IS NOT NULL
      AND LENGTH(TRIM(paciente_cpf)) > 0
  )
  WHERE rn = 1
    AND LENGTH(paciente_cpf) = 11
),

/* 2.5) UNIVERSO DE CPFs */
universo AS (
  SELECT paciente_cpf FROM presc_cpfs
  UNION DISTINCT SELECT paciente_cpf FROM cid_cpfs
  UNION DISTINCT SELECT paciente_cpf FROM lista_cpfs
)

-- 2.6) TABELA PRELIMINAR
SELECT
  u.paciente_cpf AS cpf,
  IF(p.paciente_cpf IS NOT NULL, 1, 0) AS criterio1_prescricao,
  IF(c.paciente_cpf IS NOT NULL, 1, 0) AS criterio2_cid_ativo,
  IF(l.paciente_cpf IS NOT NULL, 1, 0) AS criterio3_lista_hanseniase,
  pm.medicamentos_prescritos_mais_recente,
  li.num_sinan,
  COALESCE(li.id_cnes_lista, ei.id_cnes_ea) AS id_cnes,
  COALESCE(ei.unidade_nome_ea, CONCAT('CNES ', COALESCE(li.id_cnes_lista, ei.id_cnes_ea))) AS unidade_cadastro,
  (IF(p.paciente_cpf IS NOT NULL, 1, 0) + IF(c.paciente_cpf IS NOT NULL, 1, 0) + IF(l.paciente_cpf IS NOT NULL, 1, 0)) AS soma_criterios
FROM universo u
LEFT JOIN presc_cpfs     p      USING (paciente_cpf)
LEFT JOIN cid_cpfs       c      USING (paciente_cpf)
LEFT JOIN lista_cpfs     l      USING (paciente_cpf)
LEFT JOIN presc_meds_ult pm     USING (paciente_cpf)
LEFT JOIN lista_info     li     USING (paciente_cpf)
LEFT JOIN ea_info        ei     USING (paciente_cpf)
WHERE u.paciente_cpf IS NOT NULL AND LENGTH(u.paciente_cpf) = 11;

-- ======================================================================
-- 7) FILTRO FINAL: Apenas APS
-- ======================================================================
-- (Exemplo simplificado de update/filtro)
DELETE FROM `rj-sms-sandbox.sub_pav_us._hanseniase_em_tratamento` t
WHERE NOT EXISTS (
  SELECT 1 FROM `rj-sms.saude_dados_mestres.estabelecimento` e
  WHERE SAFE_CAST(t.id_cnes AS STRING) = SAFE_CAST(e.id_cnes AS STRING)
  AND e.tipo_sms_agrupado = 'APS'
);
                            </code></pre>
                        </div>
                    </div>

                    <!-- Conteúdo: Dicionário -->
                    <div id="dicionario" class="tab-content">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-slate-600">
                                <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3 border-r border-slate-200 w-1/4">Coluna</th>
                                        <th class="px-6 py-3 border-r border-slate-200 w-1/6">Tipo</th>
                                        <th class="px-6 py-3">Descrição</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-pink-600 bg-pink-50/30">cpf</td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">CPF do paciente (apenas dígitos).</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-blue-600 bg-blue-50/30">
                                            criterio1_prescricao</td>
                                        <td class="px-6 py-3 text-xs">INTEGER (0/1)</td>
                                        <td class="px-6 py-3">Indica se o paciente recebeu prescrição de
                                            Rifampicina/Clofazimina/Dapsona.
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-blue-600 bg-blue-50/30">
                                            criterio2_cid_ativo</td>
                                        <td class="px-6 py-3 text-xs">INTEGER (0/1)</td>
                                        <td class="px-6 py-3">Indica se houve registro de CID A30* com situação 'ATIVO'.
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-blue-600 bg-blue-50/30">
                                            criterio3_lista_hanseniase</td>
                                        <td class="px-6 py-3 text-xs">INTEGER (0/1)</td>
                                        <td class="px-6 py-3">Indica presença na lista nominal oficial (Vitacare/SINAN).
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-emerald-600 bg-emerald-50/30">
                                            soma_criterios</td>
                                        <td class="px-6 py-3 text-xs">INTEGER</td>
                                        <td class="px-6 py-3">Soma dos flags acima. Indica a força da evidência (1 a 3).
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-purple-600 bg-purple-50/30">
                                            medicamentos_prescritos...
                                        </td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Lista concatenada dos medicamentos identificados na
                                            prescrição mais recente.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
    <script src="../scripts/global.js"></script>
</body>

</html>