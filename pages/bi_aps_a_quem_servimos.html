<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Quem Servimos - BI-APS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Highlight.js -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
    <link rel="stylesheet" href="../styles/global.css">
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Mobile Header -->
    <div class="fixed w-full bg-slate-900 text-white z-50 flex items-center justify-between p-4 md:hidden">
        <div class="font-bold text-lg flex items-center gap-2">
            <i class="ph ph-bank text-sky-400"></i> BI-APS
        </div>
        <button onclick="toggleSidebar()" class="text-white focus:outline-none">
            <i class="ph ph-list text-2xl"></i>
        </button>
    </div>

    <aside id="sidebar"
        class="bg-slate-900 text-slate-300 w-64 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex flex-col h-full shadow-xl">

        <!-- Header Sidebar -->
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="bg-sky-500/10 p-2 rounded-lg text-sky-400">
                <i class="ph ph-bank text-2xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-white tracking-wide">BI-APS</h1>
                <p class="text-xs text-slate-500 uppercase tracking-wider">Documentação</p>
            </div>
        </div>

        <!-- Busca -->
        <div class="p-4">
            <div class="relative">
                <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-slate-500"></i>
                <input type="text" placeholder="Buscar query..."
                    class="w-full bg-slate-800 text-sm text-slate-200 rounded-md pl-9 pr-4 py-2 focus:outline-none focus:ring-1 focus:ring-sky-500 border border-slate-700 placeholder-slate-500">
            </div>
        </div>

        <!-- Menu de Navegação -->
        <nav class="flex-1 overflow-y-auto py-2 space-y-6 px-3">

            <!-- Link Visão Geral (Ativo) -->
            <div>
                <a href="../index.html"
                    class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium">
                    <i class="ph ph-house"></i> Visão Geral
                </a>
            </div>

            <!-- Grupo: BI APS -->
            <div>
                <h3 class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">BI APS (Atenção
                    Primária)</h3>
                <ul class="space-y-1">

                    <!-- 1. Query - QUEM SOMOS -->
                    <li>
                        <a href="./bi_aps_quem_somos.html"
                            class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-slate-400 hover:text-white">
                            <i class="ph ph-identification-card"></i> Query - QUEM SOMOS
                        </a>
                    </li>

                    <!-- 2. Query - A QUEM SERVIMOS (Dropdown) -->
                    <li>
                        <!-- Botão Pai -->
                        <button onclick="toggleSubmenu('submenu-servimos')"
                            class="sidebar-link w-full flex items-center active justify-between px-3 py-2 rounded-md text-sm text-slate-400 hover:text-white group text-left focus:outline-none">
                            <div class="flex items-center gap-3">
                                <i class="ph ph-users-three"></i>
                                A QUEM SERVIMOS
                            </div>
                            <!-- Iniciando com rotação (aberto) -->
                            <i id="chevron-servimos"
                                class="ph ph-caret-down text-slate-500 transition-transform duration-200 rotate-180"></i>
                        </button>

                        <!-- Submenu Container -->
                        <!-- Removido 'hidden' para iniciar aberto -->
                        <div id="submenu-servimos"
                            class="pl-10 pr-2 py-1 space-y-1 overflow-hidden transition-all duration-300">

                            <!-- era pra funcionar a tag active aqui -->
                            <a href="./bi_aps_hanseniase.html"
                                class="submenu-link block py-2 text-sm text-slate-400 hover:text-sky-400">
                                Query - Hanseníase
                            </a>

                            <a href="./bi_aps_a_quem_servimos.html"
                                class="submenu-link block py-2 text-sm text-slate-400 hover:text-sky-400">
                                Query - A QUEM SERVIMOS
                            </a>
                        </div>
                    </li>

                    <!-- Futuros links aqui -->
                </ul>
            </div>
        </nav>

        <!-- Footer Sidebar -->
        <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
            v1.0.0
        </div>
    </aside>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full bg-slate-50">
        <div class="flex-1 overflow-y-auto p-6 md:p-10 pt-20 md:pt-10">
            <div class="max-w-6xl mx-auto">

                <!-- Cabeçalho da Query -->
                <div
                    class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 pb-6 border-b border-slate-200">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span
                                class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide">Tabela
                                Consolidada</span>
                            <span class="text-slate-400 text-sm">/</span>
                            <span class="text-slate-500 text-sm">BI APS</span>
                        </div>
                        <h1 class="text-3xl font-bold text-slate-900">QUERY - A QUEM SERVIMOS</h1>
                        <p class="text-slate-600 mt-1">Processamento completo da base de cadastros (CPFs) com dados
                            clínicos e sociodemográficos.</p>
                    </div>
                    <div class="flex gap-3">
                        <a href="#"
                            class="flex items-center gap-2 bg-sky-600 text-white hover:bg-sky-700 px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm">
                            <i class="ph ph-arrow-square-out"></i> Abrir no BigQuery
                        </a>
                    </div>
                </div>

                <!-- Resumo / Metadados -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Tabela Final</p>
                        <p class="text-slate-800 font-medium text-xs break-all font-mono bg-slate-50 p-1 rounded">
                            rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final
                        </p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Fontes Principais</p>
                        <div class="text-slate-800 font-medium text-sm flex flex-col gap-1">
                            <span class="flex items-center gap-1"
                                title="brutos_prontuario_vitacare_historico.cadastro"><i class="ph ph-database"></i>
                                Vitacare (Cadastro)</span>
                            <span class="flex items-center gap-1" title="sub_pav_us.morbidades"><i
                                    class="ph ph-heartbeat"></i> Morbidades & Clínico</span>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Identificador Único</p>
                        <p class="text-slate-800 font-medium flex items-center gap-2">
                            <i class="ph ph-fingerprint text-amber-500"></i> CPF (Deduplicado)
                        </p>
                    </div>
                </div>

                <!-- Sistema de Abas -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-10">
                    <div class="border-b border-slate-200 flex overflow-x-auto bg-slate-50">
                        <button onclick="openTab('regras')" id="btn-regras"
                            class="tab-btn active px-6 py-4 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Regras
                            de Negócio</button>
                        <button onclick="openTab('sql')" id="btn-sql"
                            class="tab-btn px-6 py-4 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Script
                            SQL</button>
                        <button onclick="openTab('dicionario')" id="btn-dicionario"
                            class="tab-btn px-6 py-4 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Dicionário
                            de Dados</button>
                    </div>

                    <!-- Conteúdo: Regras de Negócio -->
                    <div id="regras" class="tab-content active p-8">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Pipeline de Processamento</h3>
                        <ul class="space-y-6">
                            <li class="flex gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    <span
                                        class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 font-bold text-xs">1</span>
                                </div>
                                <div>
                                    <strong class="text-slate-900 block">Limpeza e Padronização</strong>
                                    <p class="text-slate-600 text-sm mt-1">
                                        Remove caracteres especiais e acentos dos nomes. Valida CPFs (removendo
                                        sequências inválidas como '11111111111' e '00000000000'). Cria um hash SHA256
                                        (ID único) baseado no nome normalizado e data de nascimento.
                                    </p>
                                </div>
                            </li>
                            <li class="flex gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    <span
                                        class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 font-bold text-xs">2</span>
                                </div>
                                <div>
                                    <strong class="text-slate-900 block">Filtro de Cadastros Válidos</strong>
                                    <p class="text-slate-600 text-sm mt-1">
                                        Mantém apenas usuários com situação 'Ativo', cadastro 'Permanente' e sem
                                        indicativo de óbito. Remove explicitamente cadastros de teste (nomes contendo
                                        'teste', 'exemplo', 'paciente padrao').
                                    </p>
                                </div>
                            </li>
                            <li class="flex gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    <span
                                        class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 font-bold text-xs">3</span>
                                </div>
                                <div>
                                    <strong class="text-slate-900 block">Deduplicação Inteligente (CPF)</strong>
                                    <p class="text-slate-600 text-sm mt-1">
                                        Prioriza o registro mais recente (maior timestamp). Preenche lacunas de dados
                                        (raca, sexo, nome da mãe) buscando em registros históricos do mesmo CPF para
                                        evitar campos nulos (`IGNORE NULLS`).
                                    </p>
                                </div>
                            </li>
                            <li class="flex gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    <span
                                        class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-600 font-bold text-xs">4</span>
                                </div>
                                <div>
                                    <strong class="text-slate-900 block">Enriquecimento Clínico e Social</strong>
                                    <p class="text-slate-600 text-sm mt-1">
                                        Cruza dados com bases de programas sociais (Bolsa Família, Cartão Família
                                        Carioca), base de Gestações e base de Morbidades (Diabetes, Hipertensão,
                                        Tuberculose, Hanseníase, Obesidade, etc.).
                                    </p>
                                </div>
                            </li>
                            <li class="flex gap-3">
                                <div class="flex-shrink-0 mt-1">
                                    <span
                                        class="flex items-center justify-center w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 font-bold text-xs">5</span>
                                </div>
                                <div>
                                    <strong class="text-slate-900 block">Anonimização Final</strong>
                                    <p class="text-slate-600 text-sm mt-1">
                                        Gera uma tabela espelho (<code>_Anonimizada</code>) removendo dados sensíveis
                                        como Nome, Nome da Mãe e Endereço detalhado, mantendo apenas as flags clínicas e
                                        demográficas para o dashboard público.
                                    </p>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- Conteúdo: SQL -->
                    <div id="sql" class="tab-content p-0">
                        <div class="relative">
                            <button onclick="copySql()"
                                class="absolute top-4 right-4 bg-slate-700 hover:bg-slate-600 text-white text-xs px-3 py-1.5 rounded flex items-center gap-2 transition-colors z-10">
                                <i class="ph ph-copy"></i> Copiar
                            </button>
                            <pre class="m-0"><code class="language-sql shadow-none rounded-none">
---------------------------------------------------------------------
--------------------   QUERY BASE DE CADASTROS OTIMIZADA ------------
---------------------------------------------------------------------

-- Fonte primária: `rj-sms.brutos_prontuario_vitacare_historico.cadastro`

-- PASSO 1: Preparação Inicial, Limpeza Básica e Criação de ID Único
CREATE OR REPLACE TABLE `rj-sms-sandbox.sub_pav_us.base_preparada_teste1` AS
WITH
  FonteDeDados AS (
    SELECT DISTINCT *
    FROM `rj-sms.brutos_prontuario_vitacare_historico.cadastro`
  ),
  DadosComTimestampsEFlags AS (
    SELECT
      *,
      SAFE_CAST(data_cadastro AS DATETIME) AS data_cadastro_ts,
      SAFE_CAST(loaded_at AS DATETIME)   AS loaded_at_dt,
      CASE
        WHEN
          cpf IS NULL OR
          TRIM(cpf) = '' OR
          LOWER(TRIM(cpf)) IN ('na', 'n/a', 'não informado', 'none', 'teste') OR
          cpf = '00000000000' OR
          cpf IN ('11111111111','22222222222','33333333333','44444444444',
                  '55555678901','66666666666','77777777777','88888888888','99999999999') OR
          LENGTH(cpf) != 11 OR
          REGEXP_CONTAINS(cpf, r'[^0-9]')
        THEN 'Não'
        ELSE 'Sim'
      END AS cpf_valido
    FROM FonteDeDados
  ),
  LimpezaDeNomes AS (
    SELECT
      *,
      CASE
        WHEN REGEXP_CONTAINS(LOWER(TRIM(nome)), r'^(ignorado|nao informado|nao tem|nao possui|nao consta|sem informar|mae desconhecida|test|pacient|rn )')
        THEN NULL
        ELSE TRIM(
               REGEXP_REPLACE(
                 REGEXP_REPLACE(
                   REGEXP_REPLACE(
                     NORMALIZE(LOWER(TRIM(nome)), NFD),
                     r'\b(de|da|do|das|dos|a|o|as|os|e)\b', ' '
                   ),
                   r'[^a-z ]', ''
                 ),
                 r'\s+', ' '
               )
             )
      END AS nome_normalizado
    FROM DadosComTimestampsEFlags
  )
SELECT
  * EXCEPT (nome_normalizado, data_cadastro_ts, loaded_at_dt),
  TO_HEX(
    SHA256(
      CONCAT(
        COALESCE(nome_normalizado, 'sem_nome'),'_',
        COALESCE(FORMAT_DATE('%Y-%m-%d', SAFE_CAST(data_nascimento AS DATE)), 'sem_data')
      )
    )
  ) AS id_unico_preciso,
  data_cadastro_ts,
  loaded_at_dt
FROM LimpezaDeNomes;

-- PASSO 2: Filtro de ativos/permanentes/testes/datas
CREATE OR REPLACE TABLE `rj-sms-sandbox.sub_pav_us.base_filtrada_teste2` AS
WITH BasePreProcessada AS (
  SELECT
    *,
    REGEXP_REPLACE(NORMALIZE(LOWER(TRIM(nome)), NFD), r'\pM', '') AS nome_limpo_para_filtro
  FROM `rj-sms-sandbox.sub_pav_us.base_preparada_teste1`
)
SELECT
  * EXCEPT(nome_limpo_para_filtro)
FROM BasePreProcessada
WHERE
  situacao_usuario = 'Ativo'
  AND cadastro_permanente = TRUE
  AND (obito IS NULL OR obito = FALSE)
  AND LOWER(nome) NOT LIKE 'teste%'
  AND LOWER(nome) <> 'testes'
  AND NOT (
    nome_limpo_para_filtro LIKE '%teste%' OR
    nome_limpo_para_filtro LIKE '%exemplo%' OR
    nome_limpo_para_filtro LIKE 'ignorado%' OR
    nome_limpo_para_filtro LIKE 'nao informado%' OR
    nome_limpo_para_filtro LIKE 'aguardando%' OR
    nome_limpo_para_filtro LIKE 'paciente padrao%' OR
    LENGTH(nome_limpo_para_filtro) <= 1 OR
    REGEXP_CONTAINS(nome_limpo_para_filtro, r'[0-9]') OR
    nome_limpo_para_filtro IN ('sem nome','nao tem','nao possui','desconhecido')
  )
  AND EXTRACT(YEAR FROM SAFE_CAST(data_cadastro AS DATE)) <= 2025;

-- PASSO 3: Deduplicação e qualificação por CPF
CREATE OR REPLACE TABLE `rj-sms-sandbox.sub_pav_us.base_qualificada_teste3` AS
SELECT
  * EXCEPT (
      raca_cor, sexo, data_nascimento, nome_mae, nome_pai, nacionalidade, pais_nascimento,
      municipio_nascimento, estado_nascimento, identidade_genero, orientacao_sexual,
      data_cadastro_ts, loaded_at_dt
  ),
  FIRST_VALUE(NULLIF(TRIM(raca_cor), '') IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS raca_cor,
  FIRST_VALUE(NULLIF(TRIM(sexo), '') IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS sexo,
  FIRST_VALUE(data_nascimento IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS data_nascimento,
  FIRST_VALUE(NULLIF(TRIM(nome_mae), '') IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS nome_mae,
  FIRST_VALUE(NULLIF(TRIM(nome_pai), '') IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS nome_pai,
  FIRST_VALUE(NULLIF(TRIM(nacionalidade), '') IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS nacionalidade,
  FIRST_VALUE(NULLIF(TRIM(pais_nascimento), '') IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS pais_nascimento,
  FIRST_VALUE(NULLIF(TRIM(municipio_nascimento), '') IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS municipio_nascimento_nome,
  FIRST_VALUE(NULLIF(TRIM(estado_nascimento), '') IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS estado_nascimento,
  FIRST_VALUE(NULLIF(TRIM(identidade_genero), '') IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS identidade_genero,
  FIRST_VALUE(NULLIF(TRIM(orientacao_sexual), '') IGNORE NULLS) OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) AS orientacao_sexual,
  data_cadastro_ts,
  loaded_at_dt
FROM `rj-sms-sandbox.sub_pav_us.base_filtrada_teste2`
WHERE cpf_valido = 'Sim'
QUALIFY ROW_NUMBER() OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) = 1;

-- PASSO 4: Auxiliares (idade, faixa etária, flags)
CREATE OR REPLACE TABLE `rj-sms-sandbox.sub_pav_us.base_com_auxiliares_teste4` AS
SELECT
  *,
  DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) AS idade,
  CASE
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) IS NULL THEN 'Não informado'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 0  AND 4  THEN '00-04 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 5  AND 9  THEN '05-09 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 10 AND 14 THEN '10-14 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 15 AND 19 THEN '15-19 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 20 AND 24 THEN '20-24 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 25 AND 29 THEN '25-29 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 30 AND 34 THEN '30-34 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 35 AND 39 THEN '35-39 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 40 AND 44 THEN '40-44 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 45 AND 49 THEN '45-49 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 50 AND 54 THEN '50-54 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 55 AND 59 THEN '55-59 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 60 AND 64 THEN '60-64 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 65 AND 69 THEN '65-69 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 70 AND 74 THEN '70-74 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 75 AND 79 THEN '75-79 anos'
    WHEN DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) >= 80 THEN '80+ anos'
    ELSE 'Não classificado'
  END AS fx_etaria,
  (DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) = 0) AS flag_menor_1_ano,
  (DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) < 6) AS flag_menor_2_anos,
  (sexo = 'Feminino' AND DATE_DIFF(CURRENT_DATE(), SAFE_CAST(data_nascimento AS DATE), YEAR) BETWEEN 10 AND 49) AS flag_mif
FROM `rj-sms-sandbox.sub_pav_us.base_qualificada_teste3`;

-- PASSO 5: BF/CFC
CREATE OR REPLACE TABLE `rj-sms-sandbox.sub_pav_us.base_com_bf_cfc_teste5` AS
WITH
  a_com_nome_normalizado AS (
    SELECT
      *,
      REGEXP_REPLACE(NORMALIZE(LOWER(TRIM(nome)), NFD), r'\pM', '') AS nome_normalizado
    FROM `rj-sms-sandbox.sub_pav_us.base_com_auxiliares_teste4`
  ),
  b_beneficiarios_dedup AS (
    SELECT
      CAST(cpf AS STRING) AS cpf,
      REGEXP_REPLACE(NORMALIZE(LOWER(TRIM(nome_do_beneficiario)), NFD), r'\pM', '') AS nome_normalizado_b,
      data_nascimento AS data_nascimento_b,
      bf,
      cfc
    FROM (
      SELECT
        b.cpf, b.nome_do_beneficiario, b.data_nascimento, b.bf, b.cfc,
        ROW_NUMBER() OVER (
          PARTITION BY
            CASE WHEN b.cpf IS NOT NULL AND TRIM(CAST(b.cpf AS STRING)) != '' THEN CAST(b.cpf AS STRING) ELSE NULL END,
            CASE WHEN b.cpf IS NULL OR TRIM(CAST(b.cpf AS STRING)) = '' THEN CONCAT(REGEXP_REPLACE(NORMALIZE(LOWER(TRIM(b.nome_do_beneficiario)), NFD), r'\pM', ''), '_', b.data_nascimento) ELSE NULL END
          ORDER BY b.bf DESC, b.cfc DESC
        ) AS rn
      FROM `rj-sms-sandbox.sub_pav_us.beneficiarios_bf_cfc` b
      WHERE b.cpf IS NOT NULL OR b.data_nascimento IS NOT NULL
    )
    WHERE rn = 1
  )
SELECT
  a.* EXCEPT(nome_normalizado),
  COALESCE(b_cpf.bf,  b_nome.bf)  AS bf_externo,
  COALESCE(b_cpf.cfc, b_nome.cfc) AS cfc_externo
FROM a_com_nome_normalizado a
LEFT JOIN b_beneficiarios_dedup b_cpf
  ON CAST(a.cpf AS STRING) = b_cpf.cpf
LEFT JOIN b_beneficiarios_dedup b_nome
  ON b_cpf.cpf IS NULL
  AND a.data_nascimento = b_nome.data_nascimento_b
  AND a.nome_normalizado = b_nome.nome_normalizado_b;

-- PASSO 6: Qualificação final + nomes de referência
CREATE OR REPLACE TABLE `rj-sms-sandbox.sub_pav_us.base_final_pre_gestante_teste6` AS
SELECT
  a.* EXCEPT(bf_externo, cfc_externo, municipio_nascimento_nome),
  COALESCE(NULLIF(a.bf_externo, ''),  CASE WHEN a.familia_beneficiaria_auxilio_brasil = TRUE THEN 'SIM' WHEN a.familia_beneficiaria_auxilio_brasil = FALSE THEN 'NAO' ELSE NULL END) AS bf,
  COALESCE(NULLIF(a.cfc_externo, ''), CASE WHEN a.familia_beneficiaria_cfc          = TRUE THEN 'SIM' WHEN a.familia_beneficiaria_cfc          = FALSE THEN 'NAO' ELSE NULL END) AS cfc,
  CASE
    WHEN LOWER(TRIM(a.identidade_genero)) IN ('sim','não') THEN 'Preenchimento inadequado (Sim/Não)'
    WHEN LOWER(TRIM(a.identidade_genero)) = 'travesti' THEN 'Travesti'
    WHEN LOWER(TRIM(a.identidade_genero)) IN ('mulher transgãªnero','mulher transexual') THEN 'Mulher Transgênero'
    WHEN LOWER(TRIM(a.identidade_genero)) IN ('homem transgãªnero','homem transexual')  THEN 'Homem Transgênero'
    WHEN LOWER(TRIM(a.identidade_genero)) = 'mulher cisgãªnero' THEN 'Mulher Cisgênero'
    WHEN LOWER(TRIM(a.identidade_genero)) = 'homem cisgãªnero'  THEN 'Homem Cisgênero'
    WHEN LOWER(TRIM(a.identidade_genero)) = 'nã£o binã¡rio'     THEN 'Não Binário'
    WHEN LOWER(TRIM(a.identidade_genero)) = 'cis'               THEN 'Cisgênero (não especificado)'
    WHEN LOWER(TRIM(a.identidade_genero)) = 'outro'             THEN 'Outro'
    ELSE NULL
  END AS id_genero_qualificada,
  b_equipe.nome_referencia      AS nome_referencia_equipe,
  b_estabelecimento.nome_limpo  AS nome_unidade_limpo
FROM `rj-sms-sandbox.sub_pav_us.base_com_bf_cfc_teste5` a
LEFT JOIN `rj-sms.saude_dados_mestres.equipe_profissional_saude` AS b_equipe
  ON a.ine_equipe = b_equipe.id_ine
LEFT JOIN `rj-sms.saude_dados_mestres.estabelecimento` AS b_estabelecimento
  ON a.id_cnes = b_estabelecimento.ID_CNES;

-- PASSO 7: Gestação + Escolaridade + dedup final
CREATE OR REPLACE TABLE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final` AS
WITH
  base_gestantes_dedup AS (
    SELECT
      cpf, fase_atual,
      ROW_NUMBER() OVER (PARTITION BY cpf ORDER BY data_inicio DESC) AS rn
    FROM `rj-sms.projeto_gestacoes.linha_tempo`
    WHERE cpf IS NOT NULL
  ),
  BaseComGestacaoEEscolaridade AS (
    SELECT
      a.*,
      CASE WHEN b.cpf IS NOT NULL THEN 'SIM' ELSE 'NAO' END AS gestante,
      b.fase_atual,
      CASE
        WHEN a.escolaridade IS NULL THEN 'Ign/Branco'
        WHEN a.escolaridade = 'Não sabe ler/escrever' THEN 'Analfabeto'
        WHEN a.escolaridade = 'Alfabetizado' THEN 'Alfabetizado'
        WHEN a.escolaridade IN ('4º Ano/3ª Série','Fundamental Incompleto') THEN 'Fund. Incomp.'
        WHEN a.escolaridade = 'Fundamental Completo' THEN 'Fund. Comp.'
        WHEN a.escolaridade = 'Médio Incompleto' THEN 'Médio Incomp.'
        WHEN a.escolaridade = 'Médio Completo' THEN 'Médio Comp.'
        WHEN a.escolaridade = 'Superior incompleto' THEN 'Sup. Incomp.'
        WHEN a.escolaridade = 'Superior completo' THEN 'Sup. Comp.'
        WHEN a.escolaridade = 'Especialização/Residência' THEN 'Pós-grad.'
        WHEN a.escolaridade IN ('Mestrado','Doutorado') THEN 'Mest/Dout'
        WHEN a.escolaridade = 'Creche ou Pré-escola' THEN 'Creche/Pré-Escola'
        ELSE 'Outros'
      END AS escolaridade_nova,
      CASE
        WHEN a.escolaridade = 'Não sabe ler/escrever' THEN 1
        WHEN a.escolaridade = 'Alfabetizado' THEN 2
        WHEN a.escolaridade IN ('4º Ano/3ª Série','Fundamental Incompleto') THEN 3
        WHEN a.escolaridade = 'Fundamental Completo' THEN 4
        WHEN a.escolaridade = 'Médio Incompleto' THEN 5
        WHEN a.escolaridade = 'Médio Completo' THEN 6
        WHEN a.escolaridade = 'Superior incompleto' THEN 7
        WHEN a.escolaridade = 'Superior completo' THEN 8
        WHEN a.escolaridade = 'Especialização/Residência' THEN 9
        WHEN a.escolaridade IN ('Mestrado','Doutorado') THEN 10
        WHEN a.escolaridade = 'Creche ou Pré-escola' THEN 2.5
        WHEN a.escolaridade IS NULL THEN 98
        ELSE 99
      END AS escolaridade_ordem
    FROM `rj-sms-sandbox.sub_pav_us.base_final_pre_gestante_teste6` a
    LEFT JOIN base_gestantes_dedup b ON a.cpf = b.cpf AND b.rn = 1
  )
SELECT * FROM BaseComGestacaoEEscolaridade
QUALIFY ROW_NUMBER() OVER (PARTITION BY cpf ORDER BY data_cadastro_ts DESC, loaded_at_dt DESC) = 1;

-- =========================================================
-- ROTINA COMPLETA: atualiza Ativos_final e recria Anonimizada (TABLE)
-- =========================================================

-- ---------------------------------------------------------
-- (1) TUBERCULOSE: criar colunas e preencher em Ativos_final
-- ---------------------------------------------------------
ALTER TABLE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final`
ADD COLUMN IF NOT EXISTS tuberculose BOOL,
ADD COLUMN IF NOT EXISTS tuberculose_cid_ativo INT64;

-- tuberculose = TRUE se CPF estiver em _tuberculose_em_tratamento
UPDATE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final` AS v
SET v.tuberculose = TRUE
FROM `rj-sms-sandbox.sub_pav_us._tuberculose_em_tratamento` AS t
WHERE REGEXP_REPLACE(TRIM(t.cpf), r'\D', '') = REGEXP_REPLACE(TRIM(v.cpf), r'\D', '')
  AND LENGTH(REGEXP_REPLACE(TRIM(t.cpf), r'\D', '')) = 11;

-- quem não recebeu TRUE vira FALSE
UPDATE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final`
SET tuberculose = FALSE
WHERE tuberculose IS NULL;

-- copia o valor de criterio2_cid_ativo (0/1)
UPDATE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final` AS v
SET v.tuberculose_cid_ativo = t.criterio2_cid_ativo
FROM `rj-sms-sandbox.sub_pav_us._tuberculose_em_tratamento` AS t
WHERE REGEXP_REPLACE(TRIM(t.cpf), r'\D', '') = REGEXP_REPLACE(TRIM(v.cpf), r'\D', '')
  AND LENGTH(REGEXP_REPLACE(TRIM(t.cpf), r'\D', '')) = 11;

------------------------------------------------------------
-- (2) HANSENÍASE: criar colunas e preencher em Ativos_final
-- ---------------------------------------------------------
ALTER TABLE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final`
ADD COLUMN IF NOT EXISTS hanseniase BOOL,
ADD COLUMN IF NOT EXISTS hanseniase_cid_ativo INT64;

-- hanseniase = TRUE se CPF estiver em _hanseniase_em_tratamento
UPDATE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final` AS v
SET v.hanseniase = TRUE
FROM `rj-sms-sandbox.sub_pav_us._hanseniase_em_tratamento` AS h
WHERE
  REGEXP_REPLACE(TRIM(h.cpf), r'\D', '') = REGEXP_REPLACE(TRIM(v.cpf), r'\D', '')
  AND LENGTH(REGEXP_REPLACE(TRIM(h.cpf), r'\D', '')) = 11;

-- quem não recebeu TRUE vira FALSE
UPDATE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final`
SET hanseniase = FALSE
WHERE hanseniase IS NULL;

-- copia o valor de criterio2_cid_ativo (0/1) da base de hanseníase
UPDATE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final` AS v
SET v.hanseniase_cid_ativo = h.criterio2_cid_ativo
FROM `rj-sms-sandbox.sub_pav_us._hanseniase_em_tratamento` AS h
WHERE
  REGEXP_REPLACE(TRIM(h.cpf), r'\D', '') = REGEXP_REPLACE(TRIM(v.cpf), r'\D', '')
  AND LENGTH(REGEXP_REPLACE(TRIM(h.cpf), r'\D', '')) = 11;

-- ---------------------------------------------------------
-- (2) AGRAVOS CRÔNICOS: criar colunas e preencher
-- ---------------------------------------------------------
ALTER TABLE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final`
ADD COLUMN IF NOT EXISTS DM                BOOL,
ADD COLUMN IF NOT EXISTS HAS               BOOL,
ADD COLUMN IF NOT EXISTS SIDA              BOOL,
ADD COLUMN IF NOT EXISTS OBESIDADE         BOOL,
ADD COLUMN IF NOT EXISTS POLIFARMACIA      BOOL,
ADD COLUMN IF NOT EXISTS HIPERPOLIFARMACIA BOOL,
ADD COLUMN IF NOT EXISTS TABACO            BOOL,
ADD COLUMN IF NOT EXISTS PRE_DM            BOOL;

UPDATE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final` v
SET
  DM                = COALESCE(m.DM, FALSE),
  HAS               = COALESCE(m.HAS, FALSE),
  SIDA              = COALESCE(m.SIDA, FALSE),
  OBESIDADE         = COALESCE(m.OBESIDADE, FALSE),
  POLIFARMACIA      = COALESCE(m.POLIFARMACIA, FALSE),
  HIPERPOLIFARMACIA = COALESCE(m.HIPERPOLIFARMACIA, FALSE),
  TABACO            = COALESCE(m.TABACO, FALSE),
  PRE_DM            = COALESCE(m.PRE_DM, FALSE)
FROM (
  SELECT
    REGEXP_REPLACE(TRIM(cpf), r'\D', '') AS cpf_norm,
    LOGICAL_OR(HAS)               AS HAS,
    LOGICAL_OR(DM)                AS DM,
    LOGICAL_OR(SIDA)              AS SIDA,
    LOGICAL_OR(obesidade)         AS OBESIDADE,
    LOGICAL_OR(polifarmacia)      AS POLIFARMACIA,
    LOGICAL_OR(hiperpolifarmacia) AS HIPERPOLIFARMACIA,
    LOGICAL_OR(tabaco)            AS TABACO,
    LOGICAL_OR(pre_DM)            AS PRE_DM
  FROM `rj-sms-sandbox.sub_pav_us.morbidades_20251015`
  WHERE cpf IS NOT NULL
    AND LENGTH(REGEXP_REPLACE(TRIM(cpf), r'\D', '')) = 11
  GROUP BY cpf_norm
) AS m
WHERE REGEXP_REPLACE(TRIM(v.cpf), r'\D', '') = m.cpf_norm
  AND LENGTH(REGEXP_REPLACE(TRIM(v.cpf), r'\D', '')) = 11;

-- ---------------------------------------------------------
-- (3) RECRIA A BASE DO DASHBOARD (ANONIMIZADA) COMO TABELA
--     -> Sempre substitui a existente
--     -> Remove sensíveis/menos úteis e renomeia campos
-- ---------------------------------------------------------

-- elimina a tabela antiga para evitar conflito de particionamento/clusterização
DROP TABLE IF EXISTS `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Anonimizada`;

-- recria a tabela final do dashboard a partir da Ativos_final
CREATE TABLE `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Anonimizada` AS
WITH base AS (
  SELECT
    -- remove informações sensíveis / pouco úteis
    * EXCEPT(
      nome, nome_social, nome_mae, nome_pai,
      comodos, destino_lixo, luz_eletrica, tempo_moradia, tipo_domicilio,
      tipo_logradouro, tratamento_agua, meios_transporte, possui_filtro_agua,
      esgotamento_sanitario, familia_localizacao
    )
  FROM `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Ativos_final`
)
SELECT
  -- mantém tudo que sobrou e aplica renomes desejados
  base.* EXCEPT (id_cnes, unidade, ap, equipe),
  id_cnes AS unidade_cadastro,
  unidade AS unidade_nome,
  ap      AS ap_cadastro,
  equipe  AS equipe_nome
FROM base;

-- ---------------------------------------------------------
-- (4) (Opcional) VALIDAÇÕES RÁPIDAS
-- ---------------------------------------------------------
-- checar nulos em tuberculose
SELECT COUNT(*) AS n_nulls_tuberculose
FROM `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Anonimizada`
WHERE tuberculose IS NULL;

-- distribuição de tuberculose_cid_ativo
SELECT tuberculose_cid_ativo, COUNT(*) AS n
FROM `rj-sms-sandbox.sub_pav_us.VisaoGeral_Dash_Indicadores_Anonimizada`
GROUP BY tuberculose_cid_ativo;
                            </code></pre>
                        </div>
                    </div>

                    <!-- Conteúdo: Dicionário -->
                    <div id="dicionario" class="tab-content">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-slate-600">
                                <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3 border-r border-slate-200 w-1/4">Coluna</th>
                                        <th class="px-6 py-3 border-r border-slate-200 w-1/6">Tipo</th>
                                        <th class="px-6 py-3">Descrição</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-pink-600 bg-pink-50/30">
                                            id_unico_preciso</td>
                                        <td class="px-6 py-3 text-xs">STRING (HASH)</td>
                                        <td class="px-6 py-3">Hash SHA256 único gerado a partir do nome normalizado +
                                            data de nascimento.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-pink-600 bg-pink-50/30">cpf</td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Cadastro de Pessoa Física validado e deduplicado.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-blue-600 bg-blue-50/30">idade</td>
                                        <td class="px-6 py-3 text-xs">INTEGER</td>
                                        <td class="px-6 py-3">Idade calculada em anos (DATE_DIFF) em relação à data
                                            atual.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-blue-600 bg-blue-50/30">fx_etaria
                                        </td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Faixa etária quinquenal (ex: '00-04 anos', '80+ anos').
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-emerald-600 bg-emerald-50/30">bf /
                                            cfc</td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Indicador de benefício social (Bolsa Família / Cartão
                                            Família Carioca). Valores: SIM/NAO.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-emerald-600 bg-emerald-50/30">
                                            gestante</td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Flag (SIM/NAO) se o CPF consta na base ativa de
                                            acompanhamento de gestantes.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-purple-600 bg-purple-50/30">
                                            tuberculose</td>
                                        <td class="px-6 py-3 text-xs">BOOLEAN</td>
                                        <td class="px-6 py-3">Verdadeiro se paciente está em tratamento ativo de
                                            Tuberculose.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-purple-600 bg-purple-50/30">
                                            hanseniase</td>
                                        <td class="px-6 py-3 text-xs">BOOLEAN</td>
                                        <td class="px-6 py-3">Verdadeiro se paciente está em tratamento ativo de
                                            Hanseníase.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-purple-600 bg-purple-50/30">HAS / DM
                                        </td>
                                        <td class="px-6 py-3 text-xs">BOOLEAN</td>
                                        <td class="px-6 py-3">Flags para Hipertensão Arterial Sistêmica e Diabetes
                                            Mellitus.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script src="../scripts/global.js"></script>
</body>

</html>