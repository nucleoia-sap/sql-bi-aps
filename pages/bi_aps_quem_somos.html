<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quem Somos - BI APS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Highlight.js -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
    <link rel="stylesheet" href="../styles/global.css">
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- Mobile Header -->
    <div class="fixed w-full bg-slate-900 text-white z-50 flex items-center justify-between p-4 md:hidden">
        <div class="font-bold text-lg flex items-center gap-2">
            <i class="ph ph-bank text-sky-400"></i> BI-APS
        </div>
        <button onclick="toggleSidebar()" class="text-white focus:outline-none">
            <i class="ph ph-list text-2xl"></i>
        </button>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="bg-slate-900 text-slate-300 w-64 flex-shrink-0 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex flex-col h-full shadow-xl">

        <!-- Header Sidebar -->
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="bg-sky-500/10 p-2 rounded-lg text-sky-400">
                <i class="ph ph-bank text-2xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-white tracking-wide">BI-APS</h1>
                <p class="text-xs text-slate-500 uppercase tracking-wider">Documentação</p>
            </div>
        </div>

        <!-- Busca -->
        <div class="p-4">
            <div class="relative">
                <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-slate-500"></i>
                <input type="text" placeholder="Buscar query..."
                    class="w-full bg-slate-800 text-sm text-slate-200 rounded-md pl-9 pr-4 py-2 focus:outline-none focus:ring-1 focus:ring-sky-500 border border-slate-700 placeholder-slate-500">
            </div>
        </div>

        <!-- Menu de Navegação -->
        <nav class="flex-1 overflow-y-auto py-2 space-y-6 px-3">

            <!-- Link Visão Geral (Ativo) -->
            <div>
                <a href="../index.html"
                    class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium">
                    <i class="ph ph-house"></i> Visão Geral
                </a>
            </div>

            <!-- Grupo: BI APS -->
            <div>
                <h3 class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">BI APS (Atenção
                    Primária)</h3>
                <ul class="space-y-1">

                    <!-- 1. Query - QUEM SOMOS -->
                    <li>
                        <a href="./bi_aps_quem_somos.html"
                            class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md text-sm text-slate-400 hover:text-white active">
                            <i class="ph ph-identification-card"></i> Query - QUEM SOMOS
                        </a>
                    </li>

                    <!-- 2. Query - A QUEM SERVIMOS (Dropdown) -->
                    <li>
                        <!-- Botão Pai -->
                        <button onclick="toggleSubmenu('submenu-servimos')"
                            class="sidebar-link w-full flex items-center justify-between px-3 py-2 rounded-md text-sm text-slate-400 hover:text-white group text-left focus:outline-none">
                            <div class="flex items-center gap-3">
                                <i class="ph ph-users-three"></i>
                                A QUEM SERVIMOS
                            </div>
                            <!-- Iniciando com rotação (aberto) -->
                            <i id="chevron-servimos"
                                class="ph ph-caret-down text-slate-500 transition-transform duration-200 rotate-180"></i>
                        </button>

                        <!-- Submenu Container -->
                        <!-- Removido 'hidden' para iniciar aberto -->
                        <div id="submenu-servimos"
                            class="pl-10 pr-2 py-1 space-y-1 overflow-hidden transition-all duration-300">
                            <a href="./bi_aps_hanseniase.html"
                                class="submenu-link block py-2 text-sm text-slate-400 hover:text-sky-400">
                                Query - Hanseníase
                            </a>
                            <!-- Futuros links aqui -->
                            <a href="./bi_aps_a_quem_servimos.html"
                                class="submenu-link block py-2 text-sm text-slate-400 hover:text-sky-400">
                                Query - A QUEM SERVIMOS
                            </a>
                        </div>
                    </li>

                </ul>
            </div>
        </nav>

        <!-- Footer Sidebar -->
        <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
            v1.0.0
        </div>
    </aside>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative w-full bg-slate-50">
        <div class="flex-1 overflow-y-auto p-6 md:p-10 pt-20 md:pt-10">
            <div class="max-w-6xl mx-auto">

                <!-- Cabeçalho da Query -->
                <div
                    class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8 pb-6 border-b border-slate-200">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span
                                class="bg-purple-100 text-purple-700 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide">Tabela
                                Agregada</span>
                            <span class="text-slate-400 text-sm">/</span>
                            <span class="text-slate-500 text-sm">BI APS</span>
                        </div>
                        <h1 class="text-3xl font-bold text-slate-900">QUERY - QUEM SOMOS</h1>
                        <p class="text-slate-600 mt-1">Tabela base unificada de equipes e unidades de saúde com dados
                            deduplicados.</p>
                    </div>
                    <div class="flex gap-3">
                        <a href="https://console.cloud.google.com/bigquery?sq=446908838175:393c3bebd8fe4928a5d0756e0bccbb24"
                            target="_blank"
                            class="flex items-center gap-2 bg-sky-600 text-white hover:bg-sky-700 px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm">
                            <i class="ph ph-arrow-square-out"></i> Abrir no BigQuery
                        </a>
                    </div>
                </div>

                <!-- Resumo / Metadados -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Tabela de Destino</p>
                        <p class="text-slate-800 font-medium text-xs break-all font-mono bg-slate-50 p-1 rounded">
                            rj-sms-sandbox.sub_pav_us.dw_equipes_unidades_profissionais
                        </p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Fontes de Dados</p>
                        <div class="text-slate-800 font-medium text-sm flex flex-col gap-1">
                            <span class="flex items-center gap-1"><i class="ph ph-database"></i>
                                equipe_profissional_saude</span>
                            <span class="flex items-center gap-1"><i class="ph ph-hospital"></i> estabelecimento</span>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Principal Chave</p>
                        <p class="text-slate-800 font-medium flex items-center gap-2">
                            <i class="ph ph-key text-amber-500"></i> ID_INE (Equipe)
                        </p>
                    </div>
                </div>

                <!-- Sistema de Abas -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-10">
                    <div class="border-b border-slate-200 flex overflow-x-auto bg-slate-50">
                        <button onclick="openTab('regras')" id="btn-regras"
                            class="tab-btn active px-6 py-4 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Regras
                            de Negócio</button>
                        <button onclick="openTab('sql')" id="btn-sql"
                            class="tab-btn px-6 py-4 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Script
                            SQL</button>
                        <button onclick="openTab('dicionario')" id="btn-dicionario"
                            class="tab-btn px-6 py-4 text-sm font-medium text-slate-500 hover:text-slate-700 focus:outline-none">Dicionário
                            de Dados</button>
                    </div>

                    <!-- Conteúdo: Regras de Negócio -->
                    <div id="regras" class="tab-content active p-8">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Lógica de Construção</h3>
                        <ul class="space-y-4">
                            <li class="flex gap-3">
                                <i class="ph ph-check-circle text-green-500 text-xl mt-0.5"></i>
                                <div>
                                    <strong class="text-slate-900">Extração e Deduplicação:</strong>
                                    <p class="text-slate-600 text-sm mt-1">Extrai dados brutos da tabela
                                        <code>equipe_profissional_saude</code>, selecionando apenas o registro
                                        (snapshot) mais recente de cada equipe (INE).
                                    </p>
                                </div>
                            </li>
                            <li class="flex gap-3">
                                <i class="ph ph-check-circle text-green-500 text-xl mt-0.5"></i>
                                <div>
                                    <strong class="text-slate-900">Contagem de Profissionais:</strong>
                                    <p class="text-slate-600 text-sm mt-1">Conta profissionais por categoria (Médicos,
                                        Enfermeiros, ACS, etc.) de forma deduplicada. Classifica ASB e TSB com base no
                                        CBO, garantindo contagem única.</p>
                                </div>
                            </li>
                            <li class="flex gap-3">
                                <i class="ph ph-check-circle text-green-500 text-xl mt-0.5"></i>
                                <div>
                                    <strong class="text-slate-900">Enriquecimento (CNES):</strong>
                                    <p class="text-slate-600 text-sm mt-1">Combina dados da equipe com dados do
                                        estabelecimento (tabela <code>estabelecimento</code>), adicionando endereço,
                                        contatos e administração.</p>
                                </div>
                            </li>
                            <li class="flex gap-3">
                                <i class="ph ph-map-pin text-amber-500 text-xl mt-0.5"></i>
                                <div>
                                    <strong class="text-slate-900">Geolocalização:</strong>
                                    <p class="text-slate-600 text-sm mt-1">Realiza ajustes pontuais (Hardcoded updates)
                                        de latitude e longitude para unidades específicas (ex: CNES 9071385, 5476844) ao
                                        final do processamento.</p>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- Conteúdo: SQL -->
                    <div id="sql" class="tab-content p-0">
                        <div class="relative">
                            <button onclick="copySql()"
                                class="absolute top-4 right-4 bg-slate-700 hover:bg-slate-600 text-white text-xs px-3 py-1.5 rounded flex items-center gap-2 transition-colors z-10">
                                <i class="ph ph-copy"></i> Copiar
                            </button>
                            <pre class="m-0"><code class="language-sql shadow-none rounded-none">
---------------------------------------------------------------------
--------------------   QUERY BASE DE CADASTROS QUEM SOMOS-----------
---------------------------------------------------------------------
-- === DW por equipe (INE) com contagens deduplicadas e dados da unidade ===
CREATE OR REPLACE TABLE `rj-sms-sandbox.sub_pav_us.dw_equipes_unidades_profissionais` AS
WITH
-- Fonte (pode ter múltiplas linhas/snapshots por INE)
eps AS (
  SELECT *
  FROM `rj-sms.saude_dados_mestres.equipe_profissional_saude`
),

-- Metadados mais recentes por INE (nome, CNES, etc.)
eps_latest AS (
  SELECT
    id_ine,
    ARRAY_AGG(STRUCT(
      nome_referencia,
      id_cnes,
      id_equipe_tipo,
      equipe_tipo_descricao,
      id_area,
      area_descricao,
      telefone AS whatsapp_equipe,
      ultima_atualizacao_infos_equipe,
      ultima_atualizacao_profissionais
    )
    ORDER BY ultima_atualizacao_infos_equipe DESC,
             SAFE.PARSE_DATE('%Y-%m-%d', NULLIF(ultima_atualizacao_profissionais,'')) DESC NULLS LAST
    LIMIT 1)[OFFSET(0)] AS s
  FROM eps
  GROUP BY id_ine
),

-- Contagens DEDUP por categoria (valem para TODAS as linhas do INE)
med AS (
  SELECT id_ine, COUNT(DISTINCT UPPER(TRIM(p))) AS numero_de_medicos
  FROM eps, UNNEST(COALESCE(medicos, [])) p
  GROUP BY id_ine
),
enf AS (
  SELECT id_ine, COUNT(DISTINCT UPPER(TRIM(p))) AS numero_de_enfermeiros
  FROM eps, UNNEST(COALESCE(enfermeiros, [])) p
  GROUP BY id_ine
),
acs AS (
  SELECT id_ine, COUNT(DISTINCT UPPER(TRIM(p))) AS numero_de_acs
  FROM eps, UNNEST(COALESCE(agentes_comunitarios, [])) p
  GROUP BY id_ine
),
tec AS (
  SELECT id_ine, COUNT(DISTINCT UPPER(TRIM(p))) AS numero_de_tecnicos
  FROM eps, UNNEST(COALESCE(auxiliares_tecnicos_enfermagem, [])) p
  GROUP BY id_ine
),
dent AS (
  SELECT id_ine, COUNT(DISTINCT UPPER(TRIM(p))) AS numero_de_dentistas
  FROM eps, UNNEST(COALESCE(dentista, [])) p
  GROUP BY id_ine
),

-- ASB/TSB (um array único): classificar por CBO e contar 1x por profissional
sb_exp AS (
  SELECT id_ine, UPPER(TRIM(p)) AS prof_id
  FROM eps, UNNEST(COALESCE(auxiliares_tecnico_saude_bucal, [])) p
),
prof_norm AS (
  SELECT
    UPPER(TRIM(p.id_profissional_sus)) AS prof_id,
    c.id_cbo, c.cbo, c.cbo_agrupador, c.cbo_familia
  FROM `rj-sms.saude_dados_mestres.profissional_saude` p
  LEFT JOIN UNNEST(p.cbo) c
),
sb_prof AS (
  SELECT e.id_ine, n.prof_id,
         UPPER(COALESCE(n.cbo, n.cbo_agrupador, n.cbo_familia, '')) AS cbo_text
  FROM sb_exp e
  LEFT JOIN prof_norm n ON n.prof_id = e.prof_id
),
sb_per_prof AS (
  SELECT
    id_ine,
    prof_id,
    MAX(REGEXP_CONTAINS(cbo_text, r'T[ÉE]CNIC[OA].*SA[UÚ]DE BUCAL|(^|[^A-Z])TSB([^A-Z]|$)')) AS has_tsb,
    MAX(REGEXP_CONTAINS(cbo_text, r'AUXILIAR.*SA[UÚ]DE BUCAL|(^|[^A-Z])ASB([^A-Z]|$)'))       AS has_asb
  FROM sb_prof
  GROUP BY id_ine, prof_id
),
sb_agg AS (
  SELECT
    id_ine,
    COUNTIF(has_tsb) AS numero_de_tsb,                     -- prioridade TSB > ASB
    COUNTIF(NOT has_tsb AND has_asb) AS numero_de_asb
  FROM sb_per_prof
  GROUP BY id_ine
),

-- Consolidado por INE
eq_counts AS (
  SELECT
    l.id_ine,
    l.s.nome_referencia,
    l.s.id_cnes,
    l.s.id_equipe_tipo,
    l.s.equipe_tipo_descricao,
    l.s.id_area,
    l.s.area_descricao,
    l.s.whatsapp_equipe,
    l.s.ultima_atualizacao_infos_equipe AS data_cadastro_equipe,

    COALESCE(med.numero_de_medicos,0)      AS numero_de_medicos,
    COALESCE(enf.numero_de_enfermeiros,0)  AS numero_de_enfermeiros,
    COALESCE(acs.numero_de_acs,0)          AS numero_de_acs,
    COALESCE(tec.numero_de_tecnicos,0)     AS numero_de_tecnicos,
    COALESCE(dent.numero_de_dentistas,0)   AS numero_de_dentistas,
    COALESCE(sb.numero_de_asb,0)           AS numero_de_asb,
    COALESCE(sb.numero_de_tsb,0)           AS numero_de_tsb
  FROM eps_latest l
  LEFT JOIN med  USING (id_ine)
  LEFT JOIN enf  USING (id_ine)
  LEFT JOIN acs  USING (id_ine)
  LEFT JOIN tec  USING (id_ine)
  LEFT JOIN dent USING (id_ine)
  LEFT JOIN sb_agg sb USING (id_ine)
),

-- Estabelecimento: último snapshot por CNES
est_latest AS (
  SELECT * EXCEPT(rn)
  FROM (
    SELECT est.*,
           ROW_NUMBER() OVER (
             PARTITION BY id_cnes
             ORDER BY data_particao DESC, data_snapshot DESC, data_carga DESC
           ) rn
    FROM `rj-sms.saude_dados_mestres.estabelecimento` est
  )
  WHERE rn = 1
)

SELECT
  e.id_ine,
  e.nome_referencia                        AS nome_equipe,
  e.id_cnes,
  est.id_unidade,
  est.nome_limpo                           AS nome_unidade,
  est.nome_acentuado,
  est.area_programatica,
  est.ativa,
  est.tipo_sms_agrupado,
  est.tipo_sms,
  est.tipo_sms_simplificado,
  est.tipo                                  AS tipo_unidade,
  est.responsavel_sms,
  est.administracao,

  -- >>> adicionados do cadastro da equipe
  e.id_equipe_tipo,
  e.equipe_tipo_descricao,

  -- Contatos e redes
  e.whatsapp_equipe,
  est.telefone                              AS telefones_unidade,   -- ARRAY<STRING>
  est.email                                 AS email_unidade,
  est.facebook, est.instagram, est.twitter,

  -- Endereço individual + concatenado
  est.endereco_bairro,
  est.endereco_logradouro,
  est.endereco_numero,
  est.endereco_complemento,
  est.endereco_cep,
  est.endereco_latitude,
  est.endereco_longitude,
  ARRAY_TO_STRING(
    ARRAY(
      SELECT x FROM UNNEST([
        est.endereco_logradouro,
        est.endereco_numero,
        est.endereco_bairro,
        est.endereco_cep
      ]) x
      WHERE x IS NOT NULL AND x != ''
    ), ', '
  ) AS endereco_completo,

  -- Datas
  COALESCE(e.data_cadastro_equipe, est.data_particao) AS data_cadastro,

  -- Métricas finais (1 linha por INE)
  1                         AS num_equipes,
  e.numero_de_medicos,
  e.numero_de_enfermeiros,
  e.numero_de_acs,
  e.numero_de_tecnicos,
  e.numero_de_dentistas,
  e.numero_de_asb,
  e.numero_de_tsb

FROM eq_counts e
LEFT JOIN est_latest est
  ON e.id_cnes = est.id_cnes;

-- Ajustes pontuais de latitude/longitude (Updates omitidos por brevidade visual, mas incluídos no script)
-- ... (Ver código completo para updates específicos)
                            </code></pre>
                        </div>
                    </div>

                    <!-- Conteúdo: Dicionário -->
                    <div id="dicionario" class="tab-content">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-slate-600">
                                <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3 border-r border-slate-200 w-1/4">Coluna</th>
                                        <th class="px-6 py-3 border-r border-slate-200 w-1/6">Tipo</th>
                                        <th class="px-6 py-3">Descrição</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-pink-600 bg-pink-50/30">id_ine</td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Identificador Nacional de Equipe (Chave Primária).</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-pink-600 bg-pink-50/30">nome_equipe
                                        </td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Nome de referência da equipe (ex: Equipe Carioca).</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-pink-600 bg-pink-50/30">id_cnes</td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Cadastro Nacional de Estabelecimentos de Saúde vinculado.
                                        </td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-pink-600 bg-pink-50/30">nome_unidade
                                        </td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Nome limpo/padronizado da unidade de saúde.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-pink-600 bg-pink-50/30">
                                            area_programatica</td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Área de planejamento da saúde (Ex: AP 1.0, AP 3.1).</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-pink-600 bg-pink-50/30">
                                            endereco_completo</td>
                                        <td class="px-6 py-3 text-xs">STRING</td>
                                        <td class="px-6 py-3">Concatenação de logradouro, número, bairro e CEP.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-blue-600 bg-blue-50/30">
                                            numero_de_medicos</td>
                                        <td class="px-6 py-3 text-xs">INTEGER</td>
                                        <td class="px-6 py-3">Contagem distinta de médicos vinculados ao INE.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-blue-600 bg-blue-50/30">
                                            numero_de_enfermeiros</td>
                                        <td class="px-6 py-3 text-xs">INTEGER</td>
                                        <td class="px-6 py-3">Contagem distinta de enfermeiros vinculados ao INE.</td>
                                    </tr>
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-3 font-mono text-xs text-blue-600 bg-blue-50/30">
                                            numero_de_acs</td>
                                        <td class="px-6 py-3 text-xs">INTEGER</td>
                                        <td class="px-6 py-3">Contagem de Agentes Comunitários de Saúde.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script src="../scripts/global.js"></script>
</body>

</html>